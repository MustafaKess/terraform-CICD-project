name: Terraform runner_flow

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  terraform:
    runs-on: [ self-hosted ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      # <-- Add this step to set OpenStack credentials from secrets
      - name: Set OpenStack credentials
        run: |
          export OS_USERNAME=${{ secrets.OS_USERNAME }}
          export OS_PASSWORD=${{ secrets.OS_PASSWORD }}
          export OS_PROJECT_ID=${{ secrets.OS_PROJECT_ID }}
          export OS_KEYSTONE_URL=${{ secrets.OS_KEYSTONE_URL }}
          export OS_USER_DOMAIN_NAME=${{ secrets.OS_USER_DOMAIN_NAME }}
          export OS_PROJECT_DOMAIN_NAME=${{ secrets.OS_PROJECT_DOMAIN_NAME }}
          export OS_INTERFACE="public"
          export OS_ENDPOINT_TYPE="publicURL"
          export OS_IDENTITY_API_VERSION=3

          # Get token automatically
          export OS_TOKEN=$(openstack token issue -f value -c id)
          export OS_AUTH_TYPE="token"

      - name: Initialize Terraform
        run: terraform init

      - name: Plan Terraform
        run: terraform plan -var-file="environments/dev.tfvars"
